# 全局规划器的一些说明

## 算法概述

* 总体算法过程可描述如下

输入：代价地图costmap，起点start，终点goal

输出：path，数据结构为PoseStamped array

1. Dji expander计算potential

1. gradient path_maker从potential中得到路径

## 1. Dji Expander

* 第一步是根据代价地图构造出能够使用图搜索算法的模型，换句话说就是将栅格地图模型转换为图模型

* 多值的栅格模型与带权值的图模型有哪些区别，以及怎么解决，就是在这一步解决。

### 1.1 栅格模型与图模型的区别

1. 图模型的节点位置为一个编号，栅格位置为一个坐标，而机器人的位置为一个实数坐标

1. 图模型包括：节点，边权值；而栅格地图包括：栅格，栅格代价。

1. 

输入：代价地图，起点，终点

输出：potential（至今还不太清楚potential是什么意思，可能是Dji算法中的优先级吧，对应图模型中哪一个值呢）

### 1.1 wavefront algorithm

* wavefront 算法是人工势场法中的一种，但是在源代码中出现了wave plan的字样，应该描述的是遍历起点邻接点的方式，在Dji算法中使用的是方形波，即遍历栅格周围的8个邻接点，这是最直观的方式，其他的方式如菱形波（栅格周围的4个邻接点）；菱形+方波组合的；菱形+菱形+方波的。

* 由于起点不可能在某栅格的正中心处，所以采用了新的扩展方法，首先定义一个栅格以及右，上，右上的四个栅格的代价值，然后向外扩展8个邻接点（按照道理，一个2X2的栅格邻接点应该有12个，在这里去掉了4个角点，可以看作是2X2栅格的4邻接点？）

### 1.1 potential calculator

* potential是最短路径，定义为行走代价，是cost的累加

* 计算最短路径过程中的一个步骤，就是计算一个栅格到其邻接点的最短路径，定义为该栅格代价值与其最容易过去的栅格的代价值的和

* 从起点开始遍历并计算每一个栅格potential的时候，如果

* 一个点的potential，是由其代价值加上其最小potential的邻接点的值而成，即一个点的potential是到这个点的最小代价，potential就是最短路径！

#### 1.1.1 quadratic_calculator

* 由于起点并不在某栅格的最中心，所以其到其邻接栅格的代价也必须用插值的方法来计算。传统的方法就是简单地将起点栅格和周围栅格的代价值相加，而新的方法中是要考虑起点与起点栅格中心

### 1.1 expander

* 首先所有的potential都被设置为无穷大，程序中是1*e10

* 从起点开始扩展，将其所有邻接点的代价值（经过加权处理的）添加进优先级队列（按照前述的wave plan方法扩展，有精确和非精确两种方法）。此时只有起点及其邻接点加入了优先级队列。这一步是遍历的起点。


#### 1.1.1 updatecell

* 调用updatecell()一步步扩展，更新potential值，这一步就是遍历起点周围的栅格

## 1. Path Maker

* 其基类是Traceback，回溯的意思，即从终点开始沿着一定方向往回构造路径

* 其实就是沿着梯度下降方向构造路径，只是沿栅格方向是一种简化，而由于实际上机器人的质心位置几乎不可能完完全全处于某一个栅格内部，所以第二种方式是尽量进行精确的计算

* 之所以在这儿分两步，是因为构造路径这一步能够被A star算法所复用，换句话说，A star算法只不过在计算potential时候添加了启发因子而已（heuristic factor）

* 输入：potential map, start, end

* 输出：点序列 way points

* 在wavefront波碰撞算法中，对于一个栅格，它的下一个栅格是8个邻接点中potential中最小的，在Dji/A算法中，早已经确定了一个栅格的backpoint,所以算法和实现在这儿有点看不清楚。

### 1.1 grid沿栅格方向构造路径

* 算法介绍

算法逻辑很简单，从end开始搜索，end的下一个栅格是potential最小的那个

### 1.1 gradient构造路径

* 算法介绍

尽量考虑机器人的实际位置，以及不要局限于栅格，这样可以使路径更加平滑。